pipeline {
    agent { label 'ansible' }
    
    parameters {
        string(name: 'IMAGE_TAG', defaultValue: 'latest', description: 'Docker image tag to deploy')
    }
    
    environment {
        ANSIBLE_DIR = 'Deployment/ansible'
    }
    
    stages {
        stage('Clean Workspace') {
            steps {
                cleanWs()
                echo 'Workspace cleaned'
            }
        }
        
        stage('Checkout') {
            steps {
                checkout scm  
            }
        }
        
        stage('Verify Parameters') {
            steps {
                script {
                    echo "Deploying images with tag: ${params.IMAGE_TAG}"
                    if (!params.IMAGE_TAG) {
                        error "No image tag provided!"
                    }
                }
            }
        }

        stage('Setup AWS Inventory') {
            steps {
                sh '''
                    # Install required packages using apt
                    sudo apt-get update
                    sudo apt-get install -y python3-boto3 python3-botocore awscli
                    
                    # Debug: Check AWS configuration
                    echo "Checking AWS configuration..."
                    aws sts get-caller-identity || echo "AWS credentials not found"
                    
                    # Debug: Check inventory file
                    echo "Checking inventory file..."
                    ls -l /etc/ansible/aws_ec2.yaml || echo "Inventory file not found"
                    
                    # Debug: Test inventory parsing
                    echo "Testing inventory parsing..."
                    ansible-inventory -i /etc/ansible/aws_ec2.yaml --list
                '''
            }
        }
        
        stage('Run Deployment') {
            steps {
                dir(ANSIBLE_DIR) {
                    sh '''
                        # Debug: Show Ansible version and config
                        ansible --version
                        
                        # Debug: List available hosts
                        echo "Available hosts:"
                        ansible all -i /etc/ansible/aws_ec2.yaml --list-hosts
                        
                        # Run playbook with verbose output
                        ansible-playbook playbook.yaml \
                            -i /etc/ansible/aws_ec2.yaml \
                            --limit tag_Purpose_app_server \
                            -e "docker_image_tag=${IMAGE_TAG}" \
                            -v
                    '''
                }
            }
        }
    }
    
    post {
        success {
            echo "Deployment completed successfully!"
        }
        failure {
            echo "Deployment failed!"
        }
    }
}
